import{_ as e}from"./plugin-vue_export-helper-c27b6911.js";import{r as c,o,c as i,a as s,b as n,d as p,f as a}from"./app-d2bd0ec7.js";const u="/DanceStoneBlog/assets/cm9c3yeke6-5c6fb330.png",l="/DanceStoneBlog/assets/533zi6afat-4e4ab645.png",k="/DanceStoneBlog/assets/partitioning-overview-a6fcfe00.png",d="/DanceStoneBlog/assets/partitioning-spi-0624ff99.png",r={},v=a('<h2 id="spring-batch——step控制" tabindex="-1"><a class="header-anchor" href="#spring-batch——step控制" aria-hidden="true">#</a> Spring Batch——Step控制</h2><p>​ 批处理任务的主要业务逻辑都是在<code>Step</code>中去完成的。可以将<code>Job</code>理解为运行<code>Step</code>的框架，而<code>Step</code>理解为业务功能。</p><h3 id="step配置" tabindex="-1"><a class="header-anchor" href="#step配置" aria-hidden="true">#</a> Step配置</h3><p>​ <code>Step</code>是<code>Job</code>中的工作单元，每一个<code>Step</code>涵盖了单行记录的处理闭环。下图是一个<code>Step</code>的简要结构：</p><p><img src="'+u+'" alt="cm9c3yeke6"></p><p>​ 一个<code>Step</code>通常涵盖三个部分：读数据（Reader）、处理数据（Processor）和写数据（Writer）。但是并不是所有的<code>Step</code> 都需要自身来完成数据的处理，比如存储过程等方式是通过外部功能来完成，因此Spring Batch提供了2种Step的处理方式：1）面向分片的<code>ChunkStep</code>，2）面向过程的<code>TaskletStep</code>。但是基本上大部分情况下都是使用面向分片的方式来解决问题。</p><h3 id="面向分片的处理过程" tabindex="-1"><a class="header-anchor" href="#面向分片的处理过程" aria-hidden="true">#</a> 面向分片的处理过程</h3><p>​ 在<code>Step</code>中数据是按记录（按行）处理的，但是每条记录处理完毕之后马上提交事物反而会导致IO的巨大压力。因此Spring Batch提供了数据处理的分片功能。设置了分片之后，一次工作会从Read开始，然后交由给Processor处理。处理完毕后会进行聚合，待聚合到一定的数量的数据之后一次性调用Write将数据提交到物理数据库。其过程大致为：</p><p><img src="'+l+'" alt="533zi6afat"></p><p>在Spring Batch中所谓的事物和数据事物的概念一样，就是一次性提交多少数据。如果在聚合数据期间出现任何错误，所有的这些数据都将不执行写入。</p><h3 id="分区" tabindex="-1"><a class="header-anchor" href="#分区" aria-hidden="true">#</a> 分区</h3><p>Spring Batch也为Step的分区执行和远程执行提供了一个SPI(服务提供者接口)。在这种情况下,远端的执行程序只是一些简单的Step实例,配置和使用方式都和本机处理一样容易。下面是一幅实际的模型示意图:</p><p><img src="'+k+'" alt="partitioning-overview"></p><p>在左侧执行的作业(Job)是串行的Steps,而中间的那一个Step被标记为 Master。图中的 Slave 都是一个Step的相同实例,对于作业来说,这些Slave的执行结果实际上等价于就是Master的结果。Slaves通常是远程服务,但也有可能是本地执行的其他线程。在此模式中,Master发送给Slave的消息不需要持久化(durable) ,也不要求保证交付: 对每个作业执行步骤来说,保存在 <strong>JobRepository</strong> 中的Spring Batch元信息将确保每个Slave都会且仅会被执行一次。</p><p>Spring Batch的SPI由Step的一个专门的实现( <strong>PartitionStep</strong>),以及需要由特定环境实现的两个策略接口组成。这两个策略接口分别是 <strong>PartitionHandler</strong> 和 <strong>StepExecutionSplitter</strong>,他们的角色如下面的序列图所示:此时在右边的Step就是“远程”Slave。</p><p><img src="'+d+`" alt="partitioning-spi"></p><h4 id="分区处理器-partitionhandler" tabindex="-1"><a class="header-anchor" href="#分区处理器-partitionhandler" aria-hidden="true">#</a> 分区处理器(PartitionHandler)</h4><p><strong>PartitionHandler</strong>组件知道远程网格环境的组织结构。 它可以发送<strong>StepExecution</strong>请求给远端Steps,采用某种具体的数据格式,例如DTO.它不需要知道如何分割输入数据,或者如何聚合多个步骤执行的结果。一般来说它可能也不需要了解弹性或故障转移,因为在许多情况下这些都是结构的特性,无论如何Spring Batch总是提供了独立于结构的可重启能力: 一个失败的作业总是会被重新启动,并且只会重新执行失败的步骤。</p><p><strong>PartitionHandler</strong>接口可以有各种结构的实现类: 如简单RMI远程方法调用,EJB远程调用,自定义web服务、JMS、Java Spaces, 共享内存网格(如Terracotta或Coherence)、网格执行结构(如GridGain)。Spring Batch自身不包含任何专有网格或远程结构的实现。</p><p>但是 Spring Batch也提供了一个有用的<strong>PartitionHandler</strong>实现，在本地分开的线程中执行Steps,该实现类名为 <strong>TaskExecutorPartitionHandler</strong>,并且他是上面的XML配置中的默认处理器。还可以像下面这样明确地指定:</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>step</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>step1.master<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>partition</span> <span class="token attr-name">step</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>step1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">handler</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>handler<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>step</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.spr...TaskExecutorPartitionHandler<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>taskExecutor<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>taskExecutor<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>step<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>step1<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>gridSize<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>10<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>gridSize</strong>决定要创建的独立的step执行的数量,所以它可以配置为<strong>TaskExecutor</strong>中线程池的大小,或者也可以设置得比可用的线程数稍大一点,在这种情况下,执行块变得更小一些。</p><p><strong>TaskExecutorPartitionHandler</strong> 对于IO密集型步骤非常给力,比如要拷贝大量的文件,或复制文件系统到内容管理系统时。它还可用于远程执行的实现,通过为远程调用提供一个代理的步骤实现(例如使用Spring Remoting)，如下面代码注入到 Spring 容器当中使用</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">PartitionHandler</span> <span class="token function">suyqrPartitionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 分格，多线程处理</span>
    <span class="token class-name">TaskExecutorPartitionHandler</span> handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskExecutorPartitionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    handler<span class="token punctuation">.</span><span class="token function">setGridSize</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    handler<span class="token punctuation">.</span><span class="token function">setStep</span><span class="token punctuation">(</span><span class="token function">suyqrSlaveStep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    handler<span class="token punctuation">.</span><span class="token function">setTaskExecutor</span><span class="token punctuation">(</span>taskExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        handler<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> handler<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="分割器-partitioner" tabindex="-1"><a class="header-anchor" href="#分割器-partitioner" aria-hidden="true">#</a> 分割器(Partitioner)</h4><p>分割器有一个简单的职责: 仅为新的step实例生成执行环境(contexts),作为输入参数(这样重启时就不需要考虑)。 该接口只有一个方法:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Partitioner</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionContext</span><span class="token punctuation">&gt;</span></span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token keyword">int</span> gridSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个方法的返回值是一个Map对象,将每个Step执行分配的唯一名称(Map泛型中的 <strong>String</strong>),和与其相关的输入参数以<strong>ExecutionContext</strong> 的形式做一个映射。Step执行的名称( <strong>Partitioner</strong>接口返回的 <strong>Map</strong> 中的 key)在整个作业的执行过程中需要保持唯一,除此之外没有其他具体要求。简单说，实现 <code>Partitioner</code> 接口实现</p><h3 id="面向对象配置step" tabindex="-1"><a class="header-anchor" href="#面向对象配置step" aria-hidden="true">#</a> 面向对象配置Step</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Job</span> <span class="token function">sampleJob</span><span class="token punctuation">(</span><span class="token class-name">JobRepository</span> jobRepository<span class="token punctuation">,</span> <span class="token class-name">Step</span> sampleStep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jobBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;sampleJob&quot;</span><span class="token punctuation">)</span>
    			<span class="token punctuation">.</span><span class="token function">repository</span><span class="token punctuation">(</span>jobRepository<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>sampleStep<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Step</span> <span class="token function">sampleStep</span><span class="token punctuation">(</span><span class="token class-name">PlatformTransactionManager</span> transactionManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stepBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;sampleStep&quot;</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">transactionManager</span><span class="token punctuation">(</span>transactionManager<span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token function">chunk</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">//分片配置</span>
				<span class="token punctuation">.</span><span class="token function">reader</span><span class="token punctuation">(</span><span class="token function">itemReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//reader配置</span>
				<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token function">itemWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//write配置</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>观察sampleStep方法：</p><ol><li>reader: 使用ItemReader提供读数据的方法。</li><li>write：ItemWrite提供写数据的方法。</li><li>transactionManager：使用默认的 <code>PlatformTransactionManager</code> 对事物进行管理。当配置好事物之后Spring Batch会自动对事物进行管理，无需开发人员显示操作。</li><li>chunk：指定一次性数据提交的记录数，因为任务是基于Step分次处理的，当累计到chunk配置的次数则进行一次提交。提交的内容除了业务数据，还有批处理任务运行相关的元数据。</li></ol><p>是否使用<code>ItemProcessor</code>是一个可选项。如果没有Processor可以将数据视为读取并直接写入。</p><h3 id="提交间隔" tabindex="-1"><a class="header-anchor" href="#提交间隔" aria-hidden="true">#</a> 提交间隔</h3><p>​ <code>Step</code>使用<code>PlatformTransactionManager</code>管理事物。每次事物提交的间隔根据<code>chunk</code>方法中配置的数据执行。如果设置为1，那么在每一条数据处理完之后都会调用<code>ItemWrite</code>进行提交。提交间隔设置太小，那么会浪费需要多不必要的资源，提交间隔设置的太长，会导致事物链太长占用空间，并且出现失败会导致大量数据回滚。因此设定一个合理的间隔是非常必要的，这需要根据实际业务情况、性能要求、以及数据安全程度来设定。如果没有明确的评估目标，设置为10~20较为合适。</p><h3 id="配置step重启" tabindex="-1"><a class="header-anchor" href="#配置step重启" aria-hidden="true">#</a> 配置Step重启</h3><p>前文介绍了<code>Job</code>的重启，但是每次重启对<code>Step</code>也是有很大的影响的，因此需要特定的配置。</p><h4 id="限定重启次数" tabindex="-1"><a class="header-anchor" href="#限定重启次数" aria-hidden="true">#</a> 限定重启次数</h4><p>​ 某些<code>Step</code>可能用于处理一些先决的任务，所以当Job再次重启时这<code>Step</code>就没必要再执行，可以通过设置startLimit来限定某个<code>Step</code>重启的次数。当设置为1时候表示仅仅运行一次，而出现重启时将不再执行：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Step</span> <span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stepBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;step1&quot;</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token function">chunk</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">reader</span><span class="token punctuation">(</span><span class="token function">itemReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token function">itemWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">startLimit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="重启已经完成任务的step" tabindex="-1"><a class="header-anchor" href="#重启已经完成任务的step" aria-hidden="true">#</a> 重启已经完成任务的Step</h4><p>​ 在单个<code>JobInstance</code>的上下文中，如果某个<code>Step</code>已经处理完毕（COMPLETED）那么在默认情况下重启之后这个<code>Step</code>并不会再执行。可以通过设置<code>allow-start-if-complete</code>为true告知框架每次重启该<code>Step</code>都要执行：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Step</span> <span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stepBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;step1&quot;</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token function">chunk</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">reader</span><span class="token punctuation">(</span><span class="token function">itemReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token function">itemWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">allowStartIfComplete</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="配置略过逻辑" tabindex="-1"><a class="header-anchor" href="#配置略过逻辑" aria-hidden="true">#</a> 配置略过逻辑</h3><p>​ 某些时候在任务处理单个记录时中出现失败并不应该停止任务，而应该跳过继续处理下一条数据。是否跳过需要根据业务来判定，因此框架提供了跳过机制交给开发人员使用。如何配置跳过机制：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Step</span> <span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stepBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;step1&quot;</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token function">chunk</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">reader</span><span class="token punctuation">(</span><span class="token function">flatFileItemReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token function">itemWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">faultTolerant</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">skipLimit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token class-name">FlatFileParseException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码的含义是当处理过程中抛出<code>FlatFileParseException</code>异常时就跳过该条记录的处理。<code>skip-limit</code>（skipLimit方法）配置的参数表示当跳过的次数超过数值时则会导致整个<code>Step</code>失败，从而停止继续运行。还可以通过反向配置的方式来忽略某些异常：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Step</span> <span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stepBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;step1&quot;</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token function">chunk</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">reader</span><span class="token punctuation">(</span><span class="token function">flatFileItemReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token function">itemWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">faultTolerant</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">skipLimit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">noSkip</span><span class="token punctuation">(</span><span class="token class-name">FileNotFoundException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>skip</code>表示要当捕捉到<em>Exception</em>异常就跳过。但是<em>Exception</em>有很多继承类，此时可以使用<code>noSkip</code>方法指定某些异常不能跳过。</p><h3 id="设置重试逻辑" tabindex="-1"><a class="header-anchor" href="#设置重试逻辑" aria-hidden="true">#</a> 设置重试逻辑</h3><p>当处理记录出个异常之后并不希望他立即跳过或者停止运行，而是希望可以多次尝试执行直到失败：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Step</span> <span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stepBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;step1&quot;</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token function">chunk</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">reader</span><span class="token punctuation">(</span><span class="token function">itemReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token function">itemWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">faultTolerant</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">retryLimit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">retry</span><span class="token punctuation">(</span><span class="token class-name">DeadlockLoserDataAccessException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>retry(DeadlockLoserDataAccessException.class)</code>表示只有捕捉到该异常才会重试，<code>retryLimit(3)</code>表示最多重试3次，<code>faultTolerant()</code>表示启用对应的容错功能。</p><h3 id="step-中的事务" tabindex="-1"><a class="header-anchor" href="#step-中的事务" aria-hidden="true">#</a> Step 中的事务</h3><h4 id="事物回滚控制" tabindex="-1"><a class="header-anchor" href="#事物回滚控制" aria-hidden="true">#</a> 事物回滚控制</h4><p>​ 默认情况下，无论是设置了重试（retry）还是跳过（skip），只要从<code>Writer</code>抛出一个异常都会导致事物回滚。如果配置了skip机制，那么在<code>Reader</code>中抛出的异常不会导致回滚。有些从<code>Writer</code>抛出一个异常并不需要回滚数据，<code>noRollback</code>属性为<code>Step</code>提供了不必进行事物回滚的异常配置：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Step</span> <span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stepBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;step1&quot;</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token function">chunk</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">reader</span><span class="token punctuation">(</span><span class="token function">itemReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token function">itemWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">faultTolerant</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        		<span class="token comment">//不必回滚的异常</span>
				<span class="token punctuation">.</span><span class="token function">noRollback</span><span class="token punctuation">(</span><span class="token class-name">ValidationException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="事物数据读取的缓存" tabindex="-1"><a class="header-anchor" href="#事物数据读取的缓存" aria-hidden="true">#</a> 事物数据读取的缓存</h4><p>​ 一次<code>Setp</code>分为<code>Reader</code>、<code>Processor</code> 和<code>Writer</code> 三个阶段，这些阶段统称为<code>Item</code>。默认情况下如果错误不是发生在Reader阶段，那么没必要再去重新读取一次数据。但是某些场景下需要Reader部分也需要重新执行，比如Reader是从一个JMS队列中消费消息，当发生回滚的时候消息也会在队列上重放，因此也要将Reader纳入到回滚的事物中，根据这个场景可以使用<code>readerIsTransactionalQueue</code> 来配置数据重读：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Step</span> <span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stepBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;step1&quot;</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token function">chunk</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">reader</span><span class="token punctuation">(</span><span class="token function">itemReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token function">itemWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">readerIsTransactionalQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//数据重读</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="事物属性" tabindex="-1"><a class="header-anchor" href="#事物属性" aria-hidden="true">#</a> 事物属性</h4>`,61),m=s("strong",null,"隔离等级（isolation）",-1),b=s("strong",null,"传播方式（propagation）以及过期时间（timeout）",-1),g={href:"https://docs.spring.io/spring/docs/current/spring-framework-reference/data-access.html#transaction",target:"_blank",rel:"noopener noreferrer"},f=a(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Step</span> <span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//配置事物属性</span>
	<span class="token class-name">DefaultTransactionAttribute</span> attribute <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultTransactionAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	attribute<span class="token punctuation">.</span><span class="token function">setPropagationBehavior</span><span class="token punctuation">(</span><span class="token class-name">Propagation</span><span class="token punctuation">.</span><span class="token constant">REQUIRED</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	attribute<span class="token punctuation">.</span><span class="token function">setIsolationLevel</span><span class="token punctuation">(</span><span class="token class-name">Isolation</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	attribute<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stepBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;step1&quot;</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token function">chunk</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">reader</span><span class="token punctuation">(</span><span class="token function">itemReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token function">itemWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">transactionAttribute</span><span class="token punctuation">(</span>attribute<span class="token punctuation">)</span> <span class="token comment">//设置事物属性</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="向step注册-itemstream" tabindex="-1"><a class="header-anchor" href="#向step注册-itemstream" aria-hidden="true">#</a> 向Step注册 ItemStream</h3><p>​ <code>ItemStream</code>是用于每一个阶段（Reader、Processor、Writer）的”生命周期回调数据处理器“，后续的文章会详细介绍<code>ItemStream</code>。在4.×版本之后默认注入注册了通用的<code>ItemStream</code>。</p><p>有2种方式将<code>ItemStream</code>注册到<code>Step</code>中，一是使用<code>stream</code>方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Step</span> <span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stepBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;step1&quot;</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token function">chunk</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">reader</span><span class="token punctuation">(</span><span class="token function">itemReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token function">compositeItemWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token function">fileItemWriter1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token function">fileItemWriter2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>二是使用相关方法的代理：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">CompositeItemWriter</span> <span class="token function">compositeItemWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ItemWriter</span><span class="token punctuation">&gt;</span></span> writers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	writers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">fileItemWriter1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	writers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">fileItemWriter2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">CompositeItemWriter</span> itemWriter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompositeItemWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	itemWriter<span class="token punctuation">.</span><span class="token function">setDelegates</span><span class="token punctuation">(</span>writers<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> itemWriter<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="stepexecution拦截器" tabindex="-1"><a class="header-anchor" href="#stepexecution拦截器" aria-hidden="true">#</a> StepExecution拦截器</h3><p>在<code>Step</code>执行的过程中会产生各种各样的事件，开发人员可以利用各种<code>Listener</code>接口对<code>Step</code>及<code>Item</code>进行监听。通常在创建一个Step的时候添加拦截器：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Step</span> <span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stepBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;step1&quot;</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token function">chunk</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">reader</span><span class="token punctuation">(</span><span class="token function">reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">listener</span><span class="token punctuation">(</span><span class="token function">chunkListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//添加拦截器</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Spring Batch提供了多个接口以满足不同事件的监听。</p><h4 id="stepexecutionlistener" tabindex="-1"><a class="header-anchor" href="#stepexecutionlistener" aria-hidden="true">#</a> StepExecutionListener</h4><p><code>StepExecutionListener</code>可以看做一个通用的<code>Step</code>拦截器，他的作用是在Step开始之前和结束之后进行拦截处理：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">StepExecutionListener</span> <span class="token keyword">extends</span> <span class="token class-name">StepListener</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">beforeStep</span><span class="token punctuation">(</span><span class="token class-name">StepExecution</span> stepExecution<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Step执行之前</span>
    <span class="token class-name">ExitStatus</span> <span class="token function">afterStep</span><span class="token punctuation">(</span><span class="token class-name">StepExecution</span> stepExecution<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Step执行完毕之后</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在结束的时候开发人员可以自己定义返回的<code>ExitStatus</code>，用于配合流程控制（见后文）实现对整个Step执行过程的控制。</p><h4 id="chunklistener" tabindex="-1"><a class="header-anchor" href="#chunklistener" aria-hidden="true">#</a> ChunkListener</h4><p><code>ChunkListener</code>是在数据事物发生的两端被触发。<code>chunk</code>的配置决定了处理多少项记录才进行一次事物提交，<code>ChunkListener</code>的作用就是对一次事物开始之后或事物提交之后进行拦截：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ChunkListener</span> <span class="token keyword">extends</span> <span class="token class-name">StepListener</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">beforeChunk</span><span class="token punctuation">(</span><span class="token class-name">ChunkContext</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//事物开始之后，ItemReader调用之前</span>
    <span class="token keyword">void</span> <span class="token function">afterChunk</span><span class="token punctuation">(</span><span class="token class-name">ChunkContext</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//事物提交之后</span>
    <span class="token keyword">void</span> <span class="token function">afterChunkError</span><span class="token punctuation">(</span><span class="token class-name">ChunkContext</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//事物回滚之后</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果没有设定chunk也可以使用<code>ChunkListener</code>，它会被<code>TaskletStep</code>调用（<code>TaskletStep</code>见后文）。</p><h4 id="itemreadlistener" tabindex="-1"><a class="header-anchor" href="#itemreadlistener" aria-hidden="true">#</a> ItemReadListener</h4><p>该接口用于对<code>Reader</code>相关的事件进行监控：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ItemReadListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">StepListener</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">beforeRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">afterRead</span><span class="token punctuation">(</span><span class="token class-name">T</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">onReadError</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>beforeRead</code>在每次<code>Reader</code>调用之前被调用，<code>afterRead</code>在每次<code>Reader</code>成功返回之后被调用，而<code>onReadError</code>会在出现异常之后被调用，可以将其用于记录异常日志。</p><h4 id="itemprocesslistener" tabindex="-1"><a class="header-anchor" href="#itemprocesslistener" aria-hidden="true">#</a> ItemProcessListener</h4><p><code>ItemProcessListener</code>和<code>ItemReadListener</code>类似，是围绕着<code>ItemProcessor</code>进行处理的：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ItemProcessListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">StepListener</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">beforeProcess</span><span class="token punctuation">(</span><span class="token class-name">T</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//processor执行之前</span>
    <span class="token keyword">void</span> <span class="token function">afterProcess</span><span class="token punctuation">(</span><span class="token class-name">T</span> item<span class="token punctuation">,</span> <span class="token class-name">S</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//processor直线成功之后</span>
    <span class="token keyword">void</span> <span class="token function">onProcessError</span><span class="token punctuation">(</span><span class="token class-name">T</span> item<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//processor执行出现异常</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="itemwritelistener" tabindex="-1"><a class="header-anchor" href="#itemwritelistener" aria-hidden="true">#</a> ItemWriteListener</h4><p><code>ItemWriteListener</code>的功能和<code>ItemReadListener</code>、<code>ItemReadListener</code>类似，但是需要注意的是它接收和处理的数据对象是一个<code>List</code>。<code>List</code>的长度与chunk配置相关。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ItemWriteListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">StepListener</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">beforeWrite</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">afterWrite</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">onWriteError</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> exception<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="skiplistener" tabindex="-1"><a class="header-anchor" href="#skiplistener" aria-hidden="true">#</a> SkipListener</h4><p><code>ItemReadListener</code>、<code>ItemProcessListener</code>和<code>ItemWriteListener</code>都提供了错误拦截处理的机制，但是没有处理跳过（skip）的数据记录。因此框架提供了<code>SkipListener</code>来专门处理那么被跳过的记录：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SkipListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">StepListener</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">onSkipInRead</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Read期间导致跳过的异常</span>
    <span class="token keyword">void</span> <span class="token function">onSkipInProcess</span><span class="token punctuation">(</span><span class="token class-name">T</span> item<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Process期间导致跳过的异常</span>
    <span class="token keyword">void</span> <span class="token function">onSkipInWrite</span><span class="token punctuation">(</span><span class="token class-name">S</span> item<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Write期间导致跳过的异常</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>SkipListener</code>的价值是可以将那些未能成功处理的记录在某个位置保存下来，然后交给其他批处理进一步解决，或者人工来处理。Spring Batch保证以下2个特征：</p><ol><li>跳过的元素只会出现一次。</li><li><code>SkipListener</code>始终在事物提交之前被调用，这样可以保证监听器使用的事物资源不会被业务事物影响。</li></ol><h3 id="taskletstep" tabindex="-1"><a class="header-anchor" href="#taskletstep" aria-hidden="true">#</a> TaskletStep</h3><p>​ 面向分片（Chunk-oriented processing ）的过程并不是Step的唯一执行方式。比如用数据库的存储过程来处理数据，这个时候使用标准的Reader、Processor、Writer会很奇怪，针对这些情况框架提供了<code>TaskletStep</code>。 <code>TaskletStep</code>是一个非常简单的接口，仅有一个方法——<code>execute</code>。<code>TaskletStep</code>会反复的调用这个方法直到获取一个<code>RepeatStatus.FINISHED</code>返回或者抛出一个异常。所有的<code>Tasklet</code>调用都会包装在一个事物中。</p><p>注册一个<code>TaskletStep</code>非常简单，只要添加一个实现了<code>Tasklet</code>接口的类即可：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Step</span> <span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stepBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;step1&quot;</span><span class="token punctuation">)</span>
    			<span class="token punctuation">.</span><span class="token function">tasklet</span><span class="token punctuation">(</span><span class="token function">myTasklet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//注入Tasklet的实现</span>
    			<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,38),h=s("code",null,"TaskletStep",-1),S={href:"https://docs.spring.io/spring-batch/4.2.x/reference/html/step.html#taskletStep",target:"_blank",rel:"noopener noreferrer"},w=a(`<h3 id="控制step执行流程" tabindex="-1"><a class="header-anchor" href="#控制step执行流程" aria-hidden="true">#</a> 控制Step执行流程</h3><h4 id="顺序执行" tabindex="-1"><a class="header-anchor" href="#顺序执行" aria-hidden="true">#</a> 顺序执行</h4><p>顺序执行通过<code>next</code>方法来标记：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Job</span> <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jobBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;job&quot;</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token function">stepA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token function">stepB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//顺序执行</span>
				<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token function">stepC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="条件执行" tabindex="-1"><a class="header-anchor" href="#条件执行" aria-hidden="true">#</a> 条件执行</h4><p>在顺序执行的过程中，在整个执行链条中有一个<code>Step</code>执行失败则整个<code>Job</code>就会停止。但是通过条件执行，可以指定各种情况下的执行分。为了实现更加复杂的控制，可以通过<code>Step</code>执行后的退出命名来定义条件分之。先看一个简单的代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Job</span> <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jobBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;job&quot;</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token function">stepA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//启动时执行的step</span>
				<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">stepB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//默认跳转到stepB</span>
        		<span class="token comment">//当返回的ExitStatus为&quot;FAILED&quot;时，执行。</span>
				<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token function">stepA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;FAILED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">stepC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
				<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里使用来表示默认处理，是一个通配符表示处理任意字符串，对应的还可以使用?表示匹配任意字符。在上文中介绍了Step的退出都会有<code>ExitStatus</code>，命名都来源于它。下面是一个更加全面的代码。</p><ol><li>配置拦截器处理ExitCode：</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SkipCheckingListener</span> <span class="token keyword">extends</span> <span class="token class-name">StepExecutionListenerSupport</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">ExitStatus</span> <span class="token function">afterStep</span><span class="token punctuation">(</span><span class="token class-name">StepExecution</span> stepExecution<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> exitCode <span class="token operator">=</span> stepExecution<span class="token punctuation">.</span><span class="token function">getExitStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExitCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exitCode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">ExitStatus</span><span class="token punctuation">.</span><span class="token constant">FAILED</span><span class="token punctuation">.</span><span class="token function">getExitCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
             <span class="token comment">//当Skip的Item大于0时，则指定ExitStatus的内容</span>
              stepExecution<span class="token punctuation">.</span><span class="token function">getSkipCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ExitStatus</span><span class="token punctuation">(</span><span class="token string">&quot;COMPLETED WITH SKIPS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>拦截器指示当有一个以上被跳过的记录时，返回的<code>ExitStatus</code>为&quot;COMPLETED WITH SKIPS&quot;。对应的控制流程：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Job</span> <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jobBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;job&quot;</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;FAILED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//执行失败直接退出</span>
        	<span class="token comment">//有跳过元素执行 errorPrint1()</span>
			<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;COMPLETED WITH SKIPS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">errorPrint1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
			<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//默认（成功）情况下执行 Step2</span>
			<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="step的停机退出机制" tabindex="-1"><a class="header-anchor" href="#step的停机退出机制" aria-hidden="true">#</a> Step的停机退出机制</h4>`,13),y=s("code",null,"Job",-1),x={href:"https://www.chkui.com/article/spring/spring_batch_introduction",target:"_blank",rel:"noopener noreferrer"},j=s("code",null,"StepExecution",-1),q=s("code",null,"StepExecution",-1),E=s("code",null,"status",-1),I=s("code",null,"exitStatus",-1),F=s("code",null,"BatchStatus",-1),B=a(`<p>​ 前面以及介绍了<code>ExitStatus</code>的使用，他可以控制Step执行链条的条件执行过程。除此之外<code>BatchStatus</code>也会参与到过程的控制。</p><h5 id="end退出" tabindex="-1"><a class="header-anchor" href="#end退出" aria-hidden="true">#</a> End退出</h5><p>默认情况下（没有使用<code>end</code>、<code>fail</code>方法结束），<code>Job</code>要顺序执行直到退出，这个退出称为<code>end</code>。这个时候，<code>BatchStatus</code>=<code>COMPLETED</code>、<code>ExitStatus</code>=<code>COMPLETED</code>，表示成功执行。</p><p>除了<code>Step</code>链式处理自然退出，也可以显示调用<code>end</code>来退出系统。看下面的例子：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Job</span> <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jobBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;job&quot;</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//启动</span>
				<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//顺序执行</span>
				<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;FAILED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">step3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//条件执行</span>
				<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的代码，<code>step1</code>到<code>step2</code>是顺序执行，当<code>step2</code>的<code>exitStatus</code>返回&quot;FAILED&quot;时则直接<em>End退出</em>。其他情况执行<code>Step3</code>。</p><h5 id="fail退出" tabindex="-1"><a class="header-anchor" href="#fail退出" aria-hidden="true">#</a> Fail退出</h5><p>除了<code>end</code>还可以使用<code>fail</code>退出，这个时候，<code>BatchStatus</code>=<code>FAILED</code>、<code>ExitStatus</code>=<code>EARLY TERMINATION</code>，表示执行失败。这个状态与<code>End</code>最大的区别是<code>Job</code>会尝试重启执行新的<code>JobExecution</code>。看下面代码的例子：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Job</span> <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jobBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;job&quot;</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//执行step1</span>
			<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;FAILED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//step2的ExitStatus=FAILED 执行fail</span>
			<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">step3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//否则执行step3</span>
			<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="在指定的节点中断" tabindex="-1"><a class="header-anchor" href="#在指定的节点中断" aria-hidden="true">#</a> 在指定的节点中断</h5><p>Spring Batch还支持在指定的节点退出，退出后下次重启会从中断的点继续执行。中断的作用是某些批处理到某个步骤后需要人工干预，当干预完之后又接着处理：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Job</span> <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jobBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;job&quot;</span><span class="token punctuation">)</span>
	 		<span class="token comment">//如果step1的ExitStatus=COMPLETED则在step2中断</span>
			<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;COMPLETED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stopAndRestart</span><span class="token punctuation">(</span><span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			 <span class="token comment">//否则直接退出批处理</span>
			<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="程序化流程的分支" tabindex="-1"><a class="header-anchor" href="#程序化流程的分支" aria-hidden="true">#</a> 程序化流程的分支</h5><p>可以直接进行编码来控制<code>Step</code>之间的扭转，Spring Batch提供了<code>JobExecutionDecider</code>接口来协助分支管理：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyDecider</span> <span class="token keyword">implements</span> <span class="token class-name">JobExecutionDecider</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">FlowExecutionStatus</span> <span class="token function">decide</span><span class="token punctuation">(</span><span class="token class-name">JobExecution</span> jobExecution<span class="token punctuation">,</span> <span class="token class-name">StepExecution</span> stepExecution<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> status<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">someCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            status <span class="token operator">=</span> <span class="token string">&quot;FAILED&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            status <span class="token operator">=</span> <span class="token string">&quot;COMPLETED&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FlowExecutionStatus</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着将<code>MyDecider</code>作为过滤器添加到配置过程中：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Job</span> <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jobBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;job&quot;</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token function">decider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;FAILED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token function">decider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;COMPLETED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">step3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="流程分裂" tabindex="-1"><a class="header-anchor" href="#流程分裂" aria-hidden="true">#</a> 流程分裂</h4><p>在线性处理过程中，流程都是一个接着一个执行的。但是为了满足某些特殊的需要，Spring Batch提供了执行的过程分裂并行<code>Step</code>的方法。参看下面的<code>Job</code>配置：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Job</span> <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">Flow</span> flow1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlowBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SimpleFlow</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;flow1&quot;</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//并行流程1</span>
	<span class="token class-name">Flow</span> flow2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlowBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SimpleFlow</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;flow2&quot;</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token function">step3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//并行流程2</span>

	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jobBuilderFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;job&quot;</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>flow1<span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleAsyncTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//创建一个异步执行任务</span>
				<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>flow2<span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token function">step4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//2个分支执行完毕之后再执行step4。</span>
				<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里表示flow1和flow2会并行执行，待2者执行成功后执行step4。</p><h4 id="数据绑定" tabindex="-1"><a class="header-anchor" href="#数据绑定" aria-hidden="true">#</a> 数据绑定</h4><p>在<code>Job</code>或<code>Step</code>的任何位置，都可以获取到统一配置的数据。比如使用标准的Spring Framework方式：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">FlatFileItemReader</span> <span class="token function">flatFileItemReader</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${input.file.name}&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FlatFileItemReaderBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Foo</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;flatFileItemReader&quot;</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileSystemResource</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当我们通过配置文件（application.properties中 <code>input.file.name=filepath</code>）或者jvm参数（<code>-Dinput.file.name=filepath</code>）指定某些数据时，都可以通过这种方式获取到对应的配置参数。</p><p>此外，也可以从<code>JobParameters</code>从获取到<code>Job</code>运行的上下文参数：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@StepScope</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">FlatFileItemReader</span> <span class="token function">flatFileItemReader</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;#{jobParameters[&#39;input.file.name&#39;]}&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FlatFileItemReaderBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Foo</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;flatFileItemReader&quot;</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileSystemResource</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>无论是<code>JobExecution</code>还是<code>StepExecution</code>，其中的内容都可以通过这种方式去获取参数，例如：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@StepScope</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">FlatFileItemReader</span> <span class="token function">flatFileItemReader</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;#{jobExecutionContext[&#39;input.file.name&#39;]}&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FlatFileItemReaderBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Foo</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;flatFileItemReader&quot;</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileSystemResource</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>或者</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@StepScope</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">FlatFileItemReader</span> <span class="token function">flatFileItemReader</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;#{stepExecutionContext[&#39;input.file.name&#39;]}&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FlatFileItemReaderBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Foo</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;flatFileItemReader&quot;</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileSystemResource</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="step-scope" tabindex="-1"><a class="header-anchor" href="#step-scope" aria-hidden="true">#</a> Step Scope</h5><p>注意看上面的代码例子，都有一个<code>@StepScope</code>注解。这是为了进行后期绑定进行的标识。因为在Spring的IoCs容器进行初始化的阶段并没有任何的<code>*Execution</code>在执行，进而也不存在任何<code>*ExecutionContext</code>，所以这个时候根本无法注入标记的数据。所以需要使用注解显式的告诉容器直到<code>Step</code>执行的阶段才初始化这个<code>@Bean</code>。</p><h5 id="job-scope" tabindex="-1"><a class="header-anchor" href="#job-scope" aria-hidden="true">#</a> Job Scope</h5><p>Job Scope的概念和 Step Scope类似，都是用于标识在到了某个执行时间段再添加和注入Bean。<code>@JobScope</code>用于告知框架知道<code>JobInstance</code>存在时候才初始化对应的<code>@Bean</code>：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@JobScope</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token comment">// 初始化获取 jobParameters中的参数</span>
<span class="token keyword">public</span> <span class="token class-name">FlatFileItemReader</span> <span class="token function">flatFileItemReader</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;#{jobParameters[input]}&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FlatFileItemReaderBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Foo</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;flatFileItemReader&quot;</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileSystemResource</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@JobScope</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token comment">// 初始化获取jobExecutionContext中的参数</span>
<span class="token keyword">public</span> <span class="token class-name">FlatFileItemReader</span> <span class="token function">flatFileItemReader</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;#{jobExecutionContext中的参数[&#39;input.name&#39;]}&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FlatFileItemReaderBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Foo</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;flatFileItemReader&quot;</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileSystemResource</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,37);function R(L,T){const t=c("ExternalLinkIcon");return o(),i("div",null,[v,s("p",null,[n("事物的属性包括"),m,n("、"),b,n("。关于事物的控制详见"),s("a",g,[n("Spring Data Access"),p(t)]),n("的说明，下面是相关配置的方法：")]),f,s("p",null,[h,n("还支持适配器处理等，详见"),s("a",S,[n("官网说明"),p(t)]),n("。")]),w,s("p",null,[n("​ Spring Batch为"),y,n("提供了三种退出机制，这些机制为批处理的执行提供了丰富的控制方法。在介绍退出机制之前需要回顾一下 "),s("a",x,[n("数据批处理概念"),p(t)]),n("一文中关于"),j,n("的内容。在"),q,n("中有2个表示状态的值，一个名为"),E,n("，另外一个名为"),I,n("。前者也被称为"),F,n("。")]),B])}const C=e(r,[["render",R],["__file","SpringBatchStep.html.vue"]]);export{C as default};
